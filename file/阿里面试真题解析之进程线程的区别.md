# 前言

我们都知道进程是系统进行资源分配和调度的一个独立单位。线程是进程的一个实体，是CPU调度的基本单位。线程自己基本上不拥有系统资源，但是它可与同属一个进程的其他的线程共享进程所拥有的全部资源。由于线程比进程更小，基本上不拥有系统资源，线程上下文切换比进程上下文切换要快得多，所以线程调度的开销就会小得多，从而可以显著提高系统资源的利用率和吞吐量。**但是对于为什么线程上下文切换比进程要快以及进程线程上下文切换到底做了哪些事情大多数人并不是特别清楚。**本节将结合阿里面试真题，对线程和进程的区别做一个总结。

# 进程

进程是一个具有一定独立功能的程序在一个数据集上的一次动态执行的过程，是操作系统进行资源分配和调度的一个独立单位，是应用程序运行的载体。进程一般由**程序，数据集合和进程控制块**三部分组成。

# 线程

线程是操作系统调度的最小单位。一个进程可以包含多个线程，每个线程可以看做一个独立的逻辑流，线程也称为轻量级进程。在Linux下其实原本并没有线程的概念，线程和进程对于操作系统都是一样的调度，都有具有自己独立的task_struct(进程描述符)，也都有自己独立的pid，但是线程可以共享同一内存地址空间、代码段、全局变量、同一打开文件集合等等。

# 进程切换的开销

开销分成两种:

1.直接开销

2.间接开销

### 直接开销: 

1. **切换页表全局目录**
2. 切换**内核态堆栈**
3. 切换硬件上下文：寄存器当中的数据
4. 刷新TLB
5. 执行操作系统调度器的代码

### **间接开销:**

间接开销指的是由于切换到一个新进程后，各种缓存对于新的进程而言未命中的概率非常大。进程如果跨CPU调度，那么之前的TLB、L1、L2、L3缓存因为运行的进程已经变了，缓存所带来的空间局部性和时间局部性的优势失效，当前缓存起来的代码、数据失效。这将导致新进程需要重新从内存当中获取数据和代码，并将其缓存起来。从而导致穿透到内存的**IO**会变多，由于CPU和内存读取速度的差异很大，这部分带来的开销也非常大。

####  

# 线程切换的开销

**线程切换和进程切换之间的主要区别在于**：

1. 在线程切换期间，虚拟内存空间保持不变。
2. 进程切换期间，TLB会被刷新，从而使内存访问在一段时间内变得更加昂贵。

####  

# 进程线程的本质区别

1.进程**更安全**，一个进程完全不会影响另外的进程。

2.进程间通信比线程间**通信的性能差**很多。

3.线程切换开销更低。

####  

# 阿里面试真题

### 1.进程切换开销有哪些？

答：分为直接开销和间接开销 (具体答案参见上文)

解析：此处考察的不仅仅是书本上简单的上下文切换开销，需要对直接开销和间接开销的具体内容有比较好的理解，尤其需要回答出缓存失效带来的额外开销，此问题属于对计算机体系结构的考察。

### 2.线程共享哪些进程的资源？

答： 1.进程代码段 ； 2.进程的公有数据； 3.进程打开的**文件描述符；** 4.信号的处理器； 5.进程的当前目录；6.进程用户ID与进程组ID。

### 3.线程独立的资源有哪些？

答：1.线程ID；2.寄存器组的值；3.线程栈；4.错误返回码；5.线程的信号屏蔽码；6.线程的优先级。

### 4.说一说你知道的多线程和多进程的场景？

答：多进程场景比如 Nginx，一个 Master 多个 Worker，进程间只进行有限的通信，并不传递数据，每个进程使用IO多路复用去管理事件，是一个典型的多进程场景。

多线程场景比如一些web server，每到达一个请求使用一个线程去处理请求，在链接数量不大的情况下，比进程开销低很多，还可以使用线程池去优化创建和销毁线程的开销。

### 5.除了进程和线程你还知道哪些概念？

答：协程。协程是用户级线程，比如Golang当中原生支持协程概念，在用户空态去调度协程，维护和操作系统线程的多对多的关系。

# 总结

1.多线程之间堆内存共享，线程间通信可以直接基于共享内存来实现，比多进程之间通信更轻量。

2.多线程之间切换**不需要切换虚拟内存空间、文件描述符**等，所以线程的上下文切换也比多进程轻量。

3.由于进程之间空间相互独立，多进程比多线程更安全，一个进程基本上不会影响另外一个进程。

4.一般不同任务间需要大量的通信，使用多线程的场景比多进程多。但是多进程有更高的容错性，一个进程的崩溃不会导致整个系统的崩溃，在任务安全性较高的情况下，采用多进程。